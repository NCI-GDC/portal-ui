// @flow

import React from 'react';
import Relay from 'react-relay';
import withSize from 'react-sizeme';
import { isEqual, startCase, truncate } from 'lodash';
import { withState, withProps, lifecycle, compose } from 'recompose';

import { withTheme } from '@ncigdc/theme';
import { graphTitle } from '@ncigdc/theme/mixins';
import { Row } from '@ncigdc/uikit/Flex';
import DownloadVisualizationButton from '@ncigdc/components/DownloadVisualizationButton';
import BarChart from '@ncigdc/components/Charts/BarChart';
import GeneLink from '@ncigdc/components/Links/GeneLink';

const impactColors = {
  HIGH: 'rgb(185, 36, 36)',
  MODERATE: 'rgb(193, 158, 54)',
  LOW: 'rgb(49, 161, 60)',
};

const mapData = (data: Array<Object>, projectId: string): Array<Object> => (
  data.map((hit) => {
    const { transcript } = hit.consequence.hits.edges.find(c => c.node.transcript.is_canonical).node;
    const { annotation = {}, consequence_type = '', gene_symbol, aa_change } = transcript || {};
    const impact = annotation.impact;

    return {
      ...hit,
      score: hit._score,
      num_affected_cases_all: hit.occurrence.length,
      num_affected_cases_project: hit.occurrence.hits.edges.filter(o =>
        o.node.case.project.project_id === projectId
      ).length,
      num_affected_cases_by_project: hit.occurrence.hits.edges.reduce((acc, o) => ({
        ...acc,
        [o.node.case.project.project_id]: acc[o.node.case.project.project_id] ? acc[o.node.case.project.project_id] + 1 : 1,
      }), {}),
      impact,
      consequence_type: (
        <span>
          <b>{startCase(consequence_type.replace('variant', ''))}</b>
          <span style={{ marginLeft: '5px' }}>
            <GeneLink id={gene_symbol}>
              {gene_symbol}
            </GeneLink>
          </span>
          <span
            style={{
              marginLeft: '5px',
              color: impactColors[impact] || 'inherit',
            }}
          >
            {truncate(aa_change)}
          </span>
        </span>
      ),
    };
  })
);

const FrequentMutationsChartComponent = compose(
  lifecycle({
    componentDidMount() {
      this.props.relay.setVariables({ fetchData: true });
    },
    componentWillReceiveProps(next) {
      if (!isEqual(this.props.currentFilters, next.currentFilters)) {
        this.props.fetchData(next);
        this.props.fetchBarChart(next);
      }
    },
  }),
  withTheme,
  withSize()
)(({
  frequentMutationsChart,
  numCasesAggByProject,
  totalNumCases,
  projectId = '',
  theme,
  showSurvivalPlot,
  size: {
    width,
  },
  ssms: data,
}) => {
  if (!data.hits) return <div />;
  const ssms = mapData(data.hits.edges.map(x => x.node), projectId);

  const chartMargin = { top: 30, right: 50, bottom: 105, left: 40 };

  const bandWidth = (
    (width - chartMargin.right - chartMargin.left) /
    (ssms.length + 1) / (showSurvivalPlot ? 2 : 1)
  ) * 0.7;

  console.log(ssms)

  return (
    <span style={{ flex: 1 }}>
      <div style={{ textAlign: 'right', marginRight: 50, marginLeft: 30 }}>
        <DownloadVisualizationButton
          svg="#mutation-chart svg"
          data={ssms.map(fm => _.omit(fm, 'consequence_type'))}
          slug="bar-chart"
          noText
          tooltipHTML="Download image or data"
        />
      </div>
      <div style={graphTitle}>Distribution of Most Frequent Mutations</div>
      <Row id="mutation-chart" style={{ padding: '10px', justifyContent: 'center' }}>
        <BarChart
          bandwidth={bandWidth}
          data={ssms
            .sort((a, b) => b.num_affected_cases_all - a.num_affected_cases_all)
            .map(x => ({
            label: x.genomic_dna_change,
            value: x.score,
            tooltip: projectId
              ? (
                <span>
                  <b>{x.genomic_dna_change}</b><br />
                  <div>{x.num_affected_cases_project} Case{x.num_affected_cases_project > 1 ? 's' : ''}
                  &nbsp;affected in {projectId}</div>
                  <div>{x.num_affected_cases_project} / {numCasesAggByProject[projectId]}
                  &nbsp;({((x.num_affected_cases_project / numCasesAggByProject[projectId]) * 100).toFixed(2)}%)</div>
                </span>
              )
              : (
                <span><b>{x.genomic_dna_change}</b><br />
                  <div>{x.num_affected_cases_all} Case{x.num_affected_cases_all > 1 ? 's ' : ' '}
                    &nbsp;affected in all projects</div>
                  <div>{x.num_affected_cases_all} / {totalNumCases}
                  &nbsp;({((x.num_affected_cases_all / totalNumCases) * 100).toFixed(2)}%)</div>
                </span>
              ),
            href: `ssms/${x.ssm_id}`,
          }))}
          margin={chartMargin}
          height={250}
          yAxis={{ title: '# Affected Cases' }}
          styles={{
            xAxis: { stroke: theme.greyScale4, textFill: theme.greyScale3 },
            yAxis: { stroke: theme.greyScale4, textFill: theme.greyScale3 },
            bars: { fill: theme.secondary },
            tooltips: {
              fill: '#fff',
              stroke: theme.greyScale4,
              textFill: theme.greyScale3,
            },
          }}
        />
      </Row>
    </span>
  );
});

export const FrequentMutationsChartQuery = {
  initialVariables: {
    fetchData: false,
    filters: null,
    score: 'occurrence.case.project.project_id',
  },
  fragments: {
    ssms: () => Relay.QL`
      fragment on Ssms {
        dummy_field: hits (first: 1) { total }
        hits (first: 20 filters: $filters, score: $score) @include(if: $fetchData) {
          total
          edges {
            node {
              score
              genomic_dna_change
              ssm_id
              consequence {
                hits(first: 99) {
                  edges {
                    node {
                      transcript {
                        is_canonical
                      }
                    }
                  }
                }
              }
              occurrence {
                # this query is timing out
                hits(first: 1) {
                  edges {
                    node {
                      case {
                        project {
                          project_id
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    `,
  },
};

const FrequentMutationsChart = Relay.createContainer(
  FrequentMutationsChartComponent,
  FrequentMutationsChartQuery
);

export default FrequentMutationsChart;
