// @flow

import React from 'react';
import { compose, withState, lifecycle } from 'recompose';
import _ from 'lodash';
import { scaleOrdinal, schemeCategory10 } from 'd3';

import { makeFilter } from '@ncigdc/utils/filters';
import getSurvivalCurves from '@ncigdc/utils/getSurvivalCurves';
import { fetchApi } from '@ncigdc/utils/ajax';
import { EXPERIMENTAL_STRATEGIES, DATA_CATEGORIES } from '@ncigdc/utils/constants';

import { Row, Column } from '@ncigdc/uikit/Flex';
import TogglableUl from '@ncigdc/uikit/TogglableUl';
import { Tooltip } from '@ncigdc/uikit/Tooltip';

import EntityPageVerticalTable from '@ncigdc/components/EntityPageVerticalTable';
import EntityPageHorizontalTable from '@ncigdc/components/EntityPageHorizontalTable';
import CountCard from '@ncigdc/components/CountCard';
import DownloadButton from '@ncigdc/components/DownloadButton';
import FrequentMutationsContainer from '@ncigdc/components/FrequentMutationsContainer';
import MostAffectedCases from '@ncigdc/components/MostAffectedCases';
import SummaryCard from '@ncigdc/components/SummaryCard';
import BarChart from '@ncigdc/components/Charts/BarChart';
import OncoGridWrapper from '@ncigdc/components/Oncogrid/OncogridWrapper';
import SurvivalPlotWrapper from '@ncigdc/components/SurvivalPlotWrapper';

import DownloadVisualizationButton from '@ncigdc/components/DownloadVisualizationButton';

import { withTheme } from '@ncigdc/theme';
import { graphTitle } from '@ncigdc/theme/mixins';
import FileIcon from '@ncigdc/theme/icons/File';
import CaseIcon from '@ncigdc/theme/icons/Case';
import EditIcon from '@ncigdc/theme/icons/Edit';
import SurvivalIcon from '@ncigdc/theme/icons/SurvivalIcon';

const colors = scaleOrdinal(schemeCategory10);

const SPACING = '2rem';

const styles = {
  heading: {
    flexGrow: 1,
    fontSize: '2rem',
    marginBottom: 7,
    marginTop: 7,
  },
  countCard: {
    width: 'auto',
    marginBottom: SPACING,
  },
  column: {
    flexGrow: 1,
  },
  margin: {
    marginBottom: SPACING,
  },
  icon: {
    width: '4rem',
    height: '4rem',
    color: '#888',
  },
  hidden: {
    width: 0,
    height: 0,
    overflow: 'hidden',
  },
  card: {
    backgroundColor: 'white',
  },
};

const Project = ({
  state,
  authApi,
  api,
  esIndexVersion,
  defaultSurvivalRawData,
  setSelectedSurvivalData,
  selectedSurvivalData,
  width,
  theme,
  projectId,
  fileCount,
  projectName,
  programName,
  caseCount,
  diseaseType,
  primarySite,
  experimentalStrategies: es,
  dataCategories: dc,
}) => {
  const {
    clinicalCount,
    clinicalDataExportFileName,
    clinicalDataExportExpands,
    clinicalDataExportFilters,
    biospecimenCount,
    biospecimenDataExportFileName,
    biospecimenDataExportExpands,
    biospecimenDataExportFilters,
    numCasesAggByProject,
    mutatedGenesProject,
    mostAffectedCases,
    loading,
  } = state;

  const project = {}; // TODO: remove (for annotations)

  if (loading) return null;

  const experimentalStrategies = EXPERIMENTAL_STRATEGIES.reduce((result, name) => {
    const strat = es.find(item =>
      item.experimental_strategy.toLowerCase() === name.toLowerCase()
    );

    if (strat) {
      result.push(strat);
    }

    return result;
  }, []);

  const dataCategories = Object.keys(DATA_CATEGORIES).reduce((acc, key) => {
    const type = dc.find(item => item.data_category === DATA_CATEGORIES[key].full);

    return acc.concat(type || {
      data_category: DATA_CATEGORIES[key].full,
      file_count: 0,
    });
  }, []);

  const expStratConfig = {
    sortKey: 'file_count',
    showParticipant: true,
    displayKey: 'experimental_strategy',
    defaultText: 'experimental strategy',
    pluralDefaultText: 'experimental strategies',
    hideFileSize: true,
    tableTitle: 'Case and File Counts by Experimental Strategy',
    noResultsText: 'No files or cases with Experimental Strategies',
    state: {
      name: 'search.files',
    },
    filters: {
      default: {
        params: {
          filters(value) {
            return makeFilter([
              {
                field: 'cases.project.project_id',
                value: [
                  project.project_id,
                ],
              },
              {
                field: 'files.experimental_strategy',
                value: [
                  value,
                ],
              },
            ], true);
          },
        },
      },
    },
  };

  const dataCategoriesConfig = {
    sortKey: 'file_count',
    showParticipant: true,
    displayKey: 'data_category',
    defaultText: 'data category',
    hideFileSize: true,
    tableTitle: 'Case and File Counts by Data Category',
    pluralDefaultText: 'data categories',
    noResultsText: 'No files or cases with Data Categories',
    state: {
      name: 'search.files',
    },
    blacklist: ['structural rearrangement', 'dna methylation'],
    filters: {
      default: {
        params: {
          filters(value) {
            return makeFilter([
              {
                field: 'cases.project.project_id',
                value: [
                  project.project_id,
                ],
              },
              {
                field: 'files.data_category',
                value: [
                  value,
                ],
              },
            ], true);
          },
        },
      },
    },
  };

  const defaultSurvivalLegend = [`${numCasesAggByProject[projectId] || 0} cases on ${projectId}`];

  const survivalData = {
    legend: selectedSurvivalData.legend || defaultSurvivalLegend,
    rawData: selectedSurvivalData.rawData || state.survivalData,
  };

  const mutatedGenesChartData = mutatedGenesProject.map(g => ({
    gene_id: g.gene_id,
    symbol: g.symbol,
    cytoband: g.cytoband,
    num_affected_cases_project: g.case.filter(c => c.project.project_id === projectId).length,
    num_affected_cases_all: g.case.length,
    num_affected_cases_by_project: g.case.reduce((acc, c) => ({
      ...acc,
      [c.project.project_id]: acc[c.project.project_id] ? acc[c.project.project_id] + 1 : 1,
    }), {}),
    num_mutations: g.case.reduce((acc, c) => acc + c.ssm.length, 0),
  }));

  const totalNumCases = Object.keys(numCasesAggByProject).reduce((sum, b) => sum + numCasesAggByProject[b], 0);

  return (
    <span>
      <Row style={{ ...styles.margin, flexDirection: 'row-reverse' }}>
        <DownloadButton
          disabled={biospecimenCount === 0}
          filename={biospecimenDataExportFileName}
          dataExportExpands={biospecimenDataExportExpands}
          url={`${API}/cases`}
          activeText="Processing"
          inactiveText={biospecimenCount === 0 ? 'No Biospecimen Data' : 'Download Biospecimen'}
          fields={['case_id']}
          filters={
            makeFilter(_.values(_.mapValues(biospecimenDataExportFilters, (value, field) => ({ value, field }))), false)
          }
        />

        <DownloadButton
          disabled={clinicalCount === 0}
          filename={clinicalDataExportFileName}
          dataExportExpands={clinicalDataExportExpands}
          url={`${API}/cases`}
          activeText="Processing"
          inactiveText={clinicalCount === 0 ? 'No Clinical Data' : 'Download Clinical'}
          fields={['case_id']}
          filters={
            makeFilter(_.values(_.mapValues(clinicalDataExportFilters, (value, field) => ({ value, field }))), false)
          }
        />

        <Tooltip
          dir="down"
          innerHTML={`Download a manifest for use with the GDC Data Transfer Tool.
            The GDC Data Transfer Tool is recommended for transferring large volumes of data.`}
          maxWidth="250px"
        >
          <DownloadButton
            disabled={!fileCount}
            url={`${API}/files`}
            activeText="Downloading"
            inactiveText="Download manifest"
            fields={['file_id']}
            size={fileCount}
            returnType="manifest"
            format="TSV"
            filters={
              makeFilter([{ field: 'cases.project.project_id', value: projectId }], false)
            }
          />
        </Tooltip>
      </Row>

      <Row style={{ flexWrap: 'wrap' }} spacing={SPACING}>
        <span style={{ ...styles.column, ...styles.margin }}>
          <EntityPageVerticalTable
            id="summary"
            title={<span><i className="fa fa-table" /> Summary</span>}
            thToTd={[
              { th: 'Project ID', td: projectId },
              { th: 'Project Name', td: projectName },
              { th: 'Disease Type', td: [].concat(diseaseType).map(p => <div key={p}>{p}</div>) },
              { th: 'Primary Site', td: [].concat(primarySite).map(p => <div key={p}>{p}</div>) },
              { th: 'Program', td: programName },
            ]}
          />
        </span>

        <Column style={{ ...styles.margin, width: '200px' }}>
          <CountCard
            title="CASES"
            count={caseCount.toLocaleString()}
            icon={<CaseIcon style={styles.icon} className="fa-3x" />}
            style={styles.countCard}
            onCountClick={() => {
              window.location = `/search/c?filters=${
                makeFilter([{ field: 'cases.project.project_id', value: projectId }])
              }`;
            }}
          />

          <CountCard
            title="FILES"
            count={fileCount.toLocaleString()}
            icon={<FileIcon style={styles.icon} className="fa-3x" />}
            style={styles.countCard}
            onCountClick={() => {
              window.location = `/search/f?filters=${
                makeFilter([{ field: 'cases.project.project_id', value: projectId }])
              }`;
            }}
          />

          <CountCard
            title="ANNOTATIONS"
            count={(project.annotations ? project.annotations.pagination.total : 0).toLocaleString()}
            icon={<EditIcon style={styles.icon} className="fa-3x" />}
            style={{ ...styles.countCard, marginBottom: 0 }}
            {
              ...(project.annotations && project.annotations.pagination.total > 0 ? { onCountClick: () => {
                if (project.annotations.pagination.total > 1) {
                  window.location = `/annotations?filters=${
                      makeFilter([{ field: 'project.project_id', value: projectId }])
                  }`;
                } else {
                  window.location = `/annotations?filters=annotationId=${project.annotations.hits[0].annotation_id}`;
                }
              } } : {})
            }
          />
        </Column>
      </Row>

      <Row style={{ flexWrap: 'wrap' }} spacing={SPACING}>
        <span style={{ ...styles.column, ...styles.margin }}>
          <SummaryCard
            tableTitle="Cases and File Counts by Experimental Strategy"
            pieChartTitle="File Counts by Experimental Strategy"
            data={
              experimentalStrategies.map((item) => {
                const { filters, displayKey } = expStratConfig;
                const builtFilters = filters.default.params.filters(item[displayKey]);

                return {
                  ...item,
                  case_count: <a href={`/search/c?filters=${builtFilters}`}>{item.case_count.toLocaleString()}</a>,
                  file_count: <a href={`/search/f?filters=${builtFilters}`}>{item.file_count.toLocaleString()}</a>,
                };
              })
            }
            footer={`${experimentalStrategies.length} Experimental Strategies`}
            path="file_count"
            headings={[
              { key: 'experimental_strategy', title: 'Experimental Strategy', color: true },
              {
                key: 'case_count',
                title: 'Cases',
                style: { textAlign: 'right' },
              },
              {
                key: 'file_count',
                title: 'Files',
                style: { textAlign: 'right' },
              },
            ]}
          />
        </span>
        <span style={{ ...styles.column, ...styles.margin }}>
          <SummaryCard
            tableTitle="Cases and File Counts by Data Category"
            pieChartTitle="File Counts by Experimental Strategy"
            data={
              dataCategories.map((item) => {
                const { filters, displayKey } = dataCategoriesConfig;
                const builtFilters = filters.default.params.filters(item[displayKey]);

                return {
                  ...item,
                  case_count: <a href={`/search/c?filters=${builtFilters}`}>{item.case_count.toLocaleString()}</a>,
                  file_count: <a href={`/search/f?filters=${builtFilters}`}>{item.file_count.toLocaleString()}</a>,
                };
              })
            }
            footer={`${dataCategories.length} Experimental Strategies`}
            path="file_count"
            headings={[
              { key: 'data_category', title: 'Data Category', color: true },
              {
                key: 'case_count',
                title: 'Cases',
                style: { textAlign: 'right' },
              },
              {
                key: 'file_count',
                title: 'Files',
                style: { textAlign: 'right' },
              },
            ]}
          />
        </span>
      </Row>

      <Column style={styles.card}>
        <h1 style={{ ...styles.heading, padding: '1rem' }} id="mutated-genes">
          <i className="fa fa-bar-chart-o" style={{ paddingRight: '10px' }} />
          Most Frequently Mutated Genes
        </h1>
        <Row style={{ paddingBottom: '2.5rem' }}>
          <span>
            <div style={{ textAlign: 'right', marginRight: 50, marginLeft: 30 }}>
              <DownloadVisualizationButton
                disabled={!mutatedGenesChartData.length}
                svg="#mutated-genes-chart svg"
                data={mutatedGenesChartData}
                slug="bar-chart"
                tooltipHTML="Download image or data"
                noText
              />
            </div>
            <div style={graphTitle}>Distribution of Most Frequently Mutated Genes</div>
            {!!mutatedGenesChartData.length &&
              <div id="mutated-genes-chart">
                <Row style={{ padding: '2rem 2rem 0' }}>
                  <BarChart
                    data={mutatedGenesChartData.map(g => ({
                      label: g.symbol,
                      value: ((g.num_affected_cases_project / numCasesAggByProject[projectId]) * 100),
                      tooltip: `<b>${g.symbol}</b><br />
                        ${g.num_affected_cases_project} Case${g.num_affected_cases_project > 1 ? 's' : ''}
                        Affected in ${projectId}<br />
                        ${g.num_affected_cases_project} / ${numCasesAggByProject[projectId]}
                        ${((g.num_affected_cases_project / numCasesAggByProject[projectId]) * 100)
                          .toFixed(2)}%`,
                      href: `genes/${g.gene_id}`,
                    }))}
                    yAxis={{ title: '% of Cases Affected' }}
                    height={260}
                    styles={{
                      xAxis: { stroke: theme.greyScale4, textFill: theme.greyScale3 },
                      yAxis: { stroke: theme.greyScale4, textFill: theme.greyScale3 },
                      bars: { fill: theme.secondary },
                      tooltips: {
                        fill: '#fff',
                        stroke: theme.greyScale4,
                        textFill: theme.greyScale3,
                      },
                    }}
                  />
                </Row>
              </div>
            }
          </span>
          {survivalData.rawData && (
            <span style={{ ...styles.column, width: '50%' }}>
              <SurvivalPlotWrapper
                {...survivalData}
                onReset={() => setSelectedSurvivalData({})}
                height={240}
                width={width}
              />
            </span>
          )}
        </Row>
        <Column>
          {!!mutatedGenesChartData.length &&
            <EntityPageHorizontalTable
              headings={[
                { key: 'symbol', title: 'Symbol' },
                { key: 'cytoband', title: 'Cytoband' },
                {
                  key: 'num_affected_cases_project',
                  title: <span># Affected Cases<br />in {projectId}</span>,
                },
                {
                  key: 'num_affected_cases_all',
                  title: <span># Affected Cases<br /> Across all Projects</span>,
                },
                {
                  key: 'num_mutations',
                  title: '# Mutations',
                },
                {
                  title: 'Survival Analysis',
                  key: 'survival_plot',
                  style: { textAlign: 'center', width: '100px' },
                },
              ]}
              data={mutatedGenesChartData.map(g => ({
                ...g,
                symbol: <a href={`/genes/${g.gene_id}`}>{g.symbol}</a>,
                cytoband: (g.cytoband || []).join(', '),
                num_affected_cases_project:
                  `${g.num_affected_cases_project} / ${numCasesAggByProject[projectId]}
                  (${((g.num_affected_cases_project / numCasesAggByProject[projectId]) * 100).toFixed(2)}%)`,
                num_affected_cases_all: (
                  <TogglableUl
                    items={[
                      `${g.num_affected_cases_all}/${totalNumCases}
                      (${((g.num_affected_cases_all / totalNumCases) * 100).toFixed(2)}%)`,
                      ...Object.keys(g.num_affected_cases_by_project)
                        .map(k => `
                          ${k}: ${g.num_affected_cases_by_project[k]} / ${numCasesAggByProject[k]}
                          (${((g.num_affected_cases_by_project[k] / numCasesAggByProject[k]) * 100).toFixed(2)}%)`),
                    ]}
                  />
                ),
                survival_plot: (
                  <Tooltip innerHTML={`Click icon to plot ${g.symbol}`}>
                    <button
                      onClick={() => {
                        if (g.symbol !== selectedSurvivalData.id) {
                          getSurvivalCurves({
                            api: API,
                            projectId,
                            field: 'gene.symbol',
                            value: g.symbol,
                          })
                              .then(setSelectedSurvivalData);
                        } else {
                          setSelectedSurvivalData({});
                        }
                      }
                      }
                    >
                      <span
                        style={{
                          color: colors(selectedSurvivalData.id === g.symbol ? 1 : 0),
                          cursor: 'pointer',
                        }}
                      >
                        <SurvivalIcon />
                        <div style={styles.hidden}>add to survival plot</div>
                      </span>
                    </button>
                  </Tooltip>
                ),
              }))}
            />
          }
          {!mutatedGenesChartData.length && 'No mutated gene data to display'}
        </Column>
      </Column>

      <Column style={{ ...styles.card, marginTop: '2rem', position: 'static' }}>
        <h1 style={{ ...styles.heading, padding: '1rem' }} id="oncogrid">
          <i className="fa fa-th" style={{ paddingRight: '10px' }} />
          OncoGrid
        </h1>
        <OncoGridWrapper width={width} projectId={projectId} api={api} />
      </Column>

      <Column style={{ ...styles.card, marginTop: '2rem' }}>
        <h1 style={{ ...styles.heading, padding: '1rem' }} id="frequent-mutations">
          <i className="fa fa-bar-chart-o" style={{ paddingRight: '10px' }} />
          Most Frequent Mutations
        </h1>

        <FrequentMutationsContainer
          numCasesAggByProject={numCasesAggByProject}
          totalNumCases={totalNumCases}
          projectId={projectId}
          defaultSurvivalRawData={defaultSurvivalRawData}
          defaultSurvivalLegend={defaultSurvivalLegend}
          api={API}
          width={width}
          showSurvivalPlot
        />

      </Column>
      <Column style={{ ...styles.card, marginTop: '2rem' }}>
        <h1 style={{ ...styles.heading, padding: '1rem' }} id="most-affected-cases">
          <i className="fa fa-bar-chart-o" style={{ paddingRight: '10px' }} />
          Most Affected Cases
        </h1>

        <MostAffectedCases
          mostAffectedCases={_.sortBy(mostAffectedCases, c => c.gene.length).reverse()}
          project={projectId}
        />
      </Column>
    </span>
  );
};

const initialState = {
  loading: true,
};

const enhance = compose(
  withState('selectedSurvivalData', 'setSelectedSurvivalData', {}),
  withState('state', 'setState', initialState),
  lifecycle({
    getInitialState() {
      return { width: window.innerWidth };
    },

    async componentDidMount() {
      this.onResize = _.debounce(() => {
        this.setState({
          width: window.innerWidth,
        });
      }, 100);

      window.addEventListener('resize', this.onResize);

      const data1 = await fetchApi(
        'analysis/mutated_cases_count_by_project',
        { headers: { 'Content-Type': 'application/json' } }
      );

      const numCasesAggByProject = data1.aggregations.projects.buckets.reduce((acc, b) => {
        acc[b.key] = b.case_summary.case_with_ssm.doc_count;
        return acc;
      }, {});

      const data2 = await fetchApi(
        'analysis/top_mutated_genes_by_project',
        {
          headers: { 'Content-Type': 'application/json' },
          body: {
            project_id: this.props.projectId,
            fields: [
              'gene_id',
              'symbol',
              'cytoband',
              'case.project.project_id',
              'case.ssm.ssm_id',
            ].join(),
          },
        }
      );

      const mutatedGenesProject = data2.data.hits;

      const data3 = await fetchApi(
        'analysis/top_mutated_cases_by_project',
        {
          headers: { 'Content-Type': 'application/json' },
          body: {
            project_id: this.props.projectId,
            fields: [
              'case_id',
              'gene.ssm.ssm_id',
              'summary.data_categories.data_category',
              'summary.data_categories.file_count',
              'project.primary_site',
              'demographic.gender',
              'diagnoses.days_to_last_follow_up',
            ].join(),
          },
        }
      );

      const mostAffectedCases = data3.data.hits;

      const data4 = await fetchApi(
        `analysis/survival?filters=[{"op":"=","content":{"field":"project.project_id.raw","value":"${this.props.projectId}"}}]`,
        { headers: { 'Content-Type': 'application/json' } }
      );

      const survivalData = data4;

      this.props.setState(s => ({
        ...s,
        loading: false,
        numCasesAggByProject,
        mutatedGenesProject,
        mostAffectedCases,
        survivalData,
      }));
    },

    componentWillUnmount() {
      window.removeEventListener('resize', this.onResize);
    },
  }),
  withTheme
);

export default enhance(Project);
