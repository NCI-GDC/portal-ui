/* @flow */

import React from 'react';
import Relay from 'react-relay';
import _ from 'lodash';

import { RepositoryFilesLink } from '@ncigdc/components/Links/RepositoryLink';
import CaseLink from '@ncigdc/components/Links/CaseLink';
import AddCaseFilesToCartButton from '@ncigdc/components/AddCaseFilesToCartButton';

import { DATA_CATEGORIES } from '@ncigdc/utils/constants';
import { findDataCategory } from '@ncigdc/utils/data';
import { makeFilter } from '@ncigdc/utils/filters';

import type { TCategory } from '@ncigdc/utils/data/types';
import { Tr, Td } from '@ncigdc/uikit/Table';
import { Tooltip } from '@ncigdc/uikit/Tooltip';
import { withTheme } from '@ncigdc/theme';
import ProjectLink from '@ncigdc/components/Links/ProjectLink';
import AnnotationLink from '@ncigdc/components/Links/AnnotationLink';
import AnnotationsLink from '@ncigdc/components/Links/AnnotationsLink';

export type TProps = {|
  index: number,
  total: number,
  relay: {},
  node: {|
    case_id: string,
    demographic: {|
      gender: string,
    |},
    project: {|
      primary_site: string,
      project_id: string,
    |},
    summary: {|
      data_categories: Array<{|
        case_count?: number,
        data_category: TCategory,
      |}>,
    |},
  |},
  theme: Object,
|};

function massageRelayFiles(files: Object): Array<{}> {
  return _.get(files, 'hits.edges', [])
    .map(edge => edge.node)
    .map(file => ({
      ...file,
      cases: file.cases.hits.edges
      .map(edge => edge.node),
    }));
}

const getAnnotationsCount = (annotations) => {
  if (annotations.total === 1) {
    return (<AnnotationLink id={annotations.edges[0].node.annotation_id}>
      {annotations.total.toLocaleString()}
    </AnnotationLink>);
  } else if (annotations.total > 1 && annotations.total <= 20) {
    return (<AnnotationsLink
      query={{
        filters: makeFilter([{ field: 'annotations.annotation_id',
          value: annotations.edges.map(({ node: annotation }) => annotation.annotation_id) }], false),
      }}
    >
      {annotations.total.toLocaleString()}
    </AnnotationsLink>);
  } else if (annotations.total > 20) {
    return (
      <Tooltip Component={<span>Link to the Annotation List page is temporarily unavailable if number > 20</span>}>
        {annotations.total.toLocaleString()}
      </Tooltip>
    );
  }

  return annotations.total.toLocaleString();
};

export const CaseTrComponent = ({ node, index, theme, relay, total }: TProps) => {
  type TFilesLinkProps = { fields?: Array<Object>, children?: mixed };
  type TFilesLink = (props: TFilesLinkProps) => any;
  const FilesLink: TFilesLink = ({ fields = [], children }) => (
    <RepositoryFilesLink
      query={{
        filters: makeFilter([{ field: 'cases.case_id', value: [node.case_id] }, ...fields], false),
      }}
    >
      {children}
    </RepositoryFilesLink>
  );

  return (
    <Tr
      style={{
        backgroundColor: index % 2 === 0 ? theme.tableStripe : '#fff',
      }}
    >
      <Td>
        <AddCaseFilesToCartButton
          hasFiles={_.sum(node.summary.data_categories.map(dataCategory => dataCategory.file_count)) > 0}
          files={massageRelayFiles(node.files)}
          filteredFiles={massageRelayFiles(node.filteredFiles)}
          relay={relay}
          dropdownStyle={total - 1 === index ? { top: 'auto', bottom: '100%' } : {}}
        />
      </Td>
      <Td><CaseLink id={node.case_id} merge whitelist={['filters']} /></Td>
      <Td><ProjectLink id={node.project.project_id}>{node.project.project_id}</ProjectLink></Td>
      <Td>{node.primary_site}</Td>
      <Td>{node.demographic.gender}</Td>
      <Td>{node.summary.file_count > 0 ? <FilesLink>{node.summary.file_count}</FilesLink> : 0}</Td>
      {
        Object.values(DATA_CATEGORIES).map(category => {
          const count = findDataCategory(category.abbr, node.summary.data_categories).file_count || 0;
          return (
            <Td key={category.abbr}>
              {
                count > 0 ? (
                  <FilesLink fields={[{ field: 'files.data_category', value: category.full }]}>
                    {count}
                  </FilesLink>
                ) : 0
              }
            </Td>
          );
        })
      }
      <Td>{getAnnotationsCount(node.annotations.hits)}</Td>
    </Tr>
  );
};

export const CaseTrQuery = {
  initialVariables: {
    isFileDataRequired: false,
    isFilteredFileDataRequired: false,
    filesFilters: null,
  },
  fragments: {
    node: () => Relay.QL`
      fragment on Case {
        case_id
        primary_site
        project {
          project_id
        }
        annotations {
          hits(first:20) {
            total
            edges {
              node {
                annotation_id
              }
            }
          }
        }
        demographic {
          gender
        }
        summary {
          data_categories {
            file_count
            data_category
          }
          file_count
        }
        
        files @include(if: $isFileDataRequired){
          hits(first:99) {
            edges {
              node {
                id
                file_id
                access
                file_size
                cases {
                  hits(first:1) {
                    edges {
                      node {
                        project {
                          project_id
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }

        filteredFiles: files @include(if: $isFilteredFileDataRequired){
          hits(first:99, filters: $filesFilters) {
            edges {
              node {
                id
                file_id
                access
                file_size
                cases {
                  hits(first:1) {
                    edges {
                      node {
                        project {
                          project_id
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }

      }
    `,
  },
};

const CaseTr = Relay.createContainer(
  withTheme(CaseTrComponent),
  CaseTrQuery
);

export default CaseTr;
