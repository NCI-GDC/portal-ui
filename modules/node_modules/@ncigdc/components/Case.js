// @flow

import React from 'react';
import FileIcon from 'react-icons/lib/fa/file-o';
import { compose } from 'recompose';
import JSURL from 'jsurl';
import { connect } from 'react-redux';

import LocationSubscriber from '@ncigdc/components/LocationSubscriber';
import withRouter from '@ncigdc/utils/withRouter';
import { makeFilter, mergeQuery, setFilter, replaceFilters } from '@ncigdc/utils/filters';
import { EXPERIMENTAL_STRATEGIES, DATA_CATEGORIES } from '@ncigdc/utils/constants';
import { parseFilterParam, removeEmptyKeys } from '@ncigdc/utils/uri';
import Column from '@ncigdc/uikit/Flex/Column';
import Row from '@ncigdc/uikit/Flex/Row';
import CountCard from '@ncigdc/components/CountCard';
import SummaryCard from '@ncigdc/components/SummaryCard';
import EntityPageVerticalTable from '@ncigdc/components/EntityPageVerticalTable';
import ClinicalCard from '@ncigdc/components/ClinicalCard';
import BiospecimenCard from '@ncigdc/components/BiospecimenCard';
import FrequentMutations from '@ncigdc/components/FrequentMutations';
import { withTheme } from '@ncigdc/theme';
import Link from '@ncigdc/components/Links/Link';
import Button from '@ncigdc/uikit/Button';
import { toggleFilesInCart } from '@ncigdc/dux/cart';

import type { TRawQuery } from '@ncigdc/utils/uri/types';

const styles = {
  icon: {
    width: '4rem',
    height: '4rem',
    color: '#888',
  },
  card: {
    backgroundColor: 'white',
  },
  heading: {
    flexGrow: 1,
    fontSize: '2rem',
    marginBottom: 7,
    marginTop: 7,
  },
};

const enhance = compose(
  withRouter,
  withTheme,
  connect(state => ({ cartFiles: state.cart.files })),
);

const Case = ({
  node,
  totalNumCases,
  theme,
  numCasesAggByProject,
  push,
  query,
  dispatch,
  cartFiles,
  totalFiles,
  files,
}: {
  node: Object,
  totalNumCases: number,
  theme: Object,
  numCasesAggByProject: Array<{ [string]: number }>,
  push: Function,
  query: Object,
  dispatch: Function,
  cartFiles: Array<Object>,
  totalFiles: number,
  files: Array<Object>,
}) => {
  const p = node;

  const annotationIds = p.annotations.hits.edges.map(annotation =>
    annotation.annotation_id
  );

  const experimentalStrategies = EXPERIMENTAL_STRATEGIES.reduce((result, name) => {
    const strat = p.summary.experimental_strategies.find(item =>
      item.experimental_strategy.toLowerCase() === name.toLowerCase()
    );

    if (strat) {
      const linkQuery = {
        filters: makeFilter([
          { field: 'cases.case_id', value: p.case_id },
          { field: 'files.experimental_strategy', value: [strat.experimental_strategy] },
        ], false),
        facetTab: 'files',
        searchTableTab: 'files',
      };

      return [
        ...result,
        {
          ...strat,
          id: strat.experimental_strategy,
          file_count: (
            <Link
              merge="replace"
              pathname="/repository"
              query={linkQuery}
            >
              {strat.file_count}
            </Link>
          ),
          file_count_value: strat.file_count,
          tooltip: (
            <span>
              <b>{strat.experimental_strategy}</b><br />
              {strat.file_count} file{strat.file_count > 1 ? 's' : ''}
            </span>
          ),
          clickHandler: () => {
            const newQuery = mergeQuery(linkQuery, query, 'replace');
            const q = removeEmptyKeys({ ...newQuery, filters: newQuery.filters && JSURL.stringify(newQuery.filters) });
            push({ pathname: '/repository', query: q });
          },
        },
      ];
    }

    return result;
  }, []);

  const dataCategories = Object.keys(DATA_CATEGORIES).reduce((acc, key) => {
    const type = p.summary.data_categories.find(item => item.data_category === DATA_CATEGORIES[key].full) || {
      data_category: DATA_CATEGORIES[key].full,
      file_count: 0,
    };

    const linkQuery = {
      filters: makeFilter([
        { field: 'cases.case_id', value: p.case_id },
        { field: 'files.data_category', value: [type.data_category] },
      ], false),
      facetTab: 'files',
      searchTableTab: 'files',
    };

    return acc.concat({
      ...type,
      id: type.data_category,
      file_count: (
        <Link
          merge="replace"
          pathname="/repository"
          query={linkQuery}
        >
          {type.file_count}
        </Link>
      ),
      file_count_value: type.file_count,
      tooltip: (
        <span>
          <b>{type.data_category}</b><br />
          {type.file_count} file{type.file_count > 1 ? 's' : ''}
        </span>
      ),
      clickHandler: () => {
        const newQuery = mergeQuery(linkQuery, query, 'replace');
        const q = removeEmptyKeys({ ...newQuery, filters: newQuery.filters && JSURL.stringify(newQuery.filters) });
        push({ pathname: '/repository', query: q });
      },
    });
  }, []);

  const filesToAdd = files.filter(f => !cartFiles.some(cf => cf.file_id === f.file_id));

  return (
    <Column spacing={theme.spacing}>
      <Row style={{ justifyContent: 'flex-end' }}>
        <Button onClick={() => dispatch(toggleFilesInCart(filesToAdd.length ? filesToAdd : files))}>
          {filesToAdd.length ? 'Add all files to the cart' : 'Remove all files from the cart'}
        </Button>
      </Row>

      <Row spacing={theme.spacing}>
        <EntityPageVerticalTable
          id="summary"
          title={<span><i className="fa fa-table" /> Summary</span>}
          thToTd={[
            { th: 'Case UUID', td: p.case_id },
            { th: 'Case Submitter ID', td: p.submitter_id },
            {
              th: 'Project ID',
              td: <Link pathname={`/projects/${p.project.project_id}`}>{p.project.project_id}</Link>,
            },
            { th: 'Project Name', td: p.project.name },
            { th: 'Disease Type', td: p.project.disease_type },
            { th: 'Program', td: p.project.program.name },
            { th: 'Primary Site', td: p.project.primary_site },
          ]}
          style={{ flex: 1 }}
        />

        <Column style={{ width: '200px' }} spacing={theme.spacing}>
          <CountCard
            style={{ width: 'auto' }}
            title="FILES"
            count={totalFiles.toLocaleString()}
            icon={<FileIcon style={styles.icon} />}
            linkParams={totalFiles ? {
              pathname: '/repository',
              query: {
                filters: makeFilter([{ field: 'cases.case_id', value: p.case_id }], false),
                facetTab: 'files',
                searchTableTab: 'files',
              },
            } : null}
          />
          <CountCard
            style={{ width: 'auto' }}
            title="ANNOTATIONS"
            count={(annotationIds || []).length.toLocaleString()}
            icon={<i className="fa fa-edit" style={styles.icon} />}
            linkParams={(annotationIds || []).length ? {
              pathname: '/annotations',
              query: {
                filters: makeFilter([{ field: 'annotations.case_id', value: p.case_id }], false),
              },
            } : null}
          />
        </Column>
      </Row>

      <Row style={{ flexWrap: 'wrap' }} spacing={theme.spacing}>
        <span style={{ flex: 1 }}>
          <SummaryCard
            tableTitle="File Counts by Experimental Strategy"
            pieChartTitle="File Counts by Experimental Strategy"
            data={experimentalStrategies}
            footer={`${(experimentalStrategies || []).length} Experimental Strategies`}
            path="file_count_value"
            headings={[
              { key: 'experimental_strategy', title: 'Experimental Strategy', color: true },
              {
                key: 'file_count',
                title: 'Files',
                style: { textAlign: 'right' },
              },
            ]}
          />
        </span>
        <span style={{ flex: 1 }}>
          <SummaryCard
            tableTitle="File Counts by Data Category"
            pieChartTitle="File Counts by Experimental Strategy"
            data={dataCategories}
            footer={`${(dataCategories || []).length} Experimental Strategies`}
            path="file_count_value"
            headings={[
              { key: 'data_category', title: 'Data Category', color: true },
              {
                key: 'file_count',
                title: 'Files',
                style: { textAlign: 'right' },
              },
            ]}
          />
        </span>
      </Row>

      <Row id="clinical" style={{ flexWrap: 'wrap' }} spacing={theme.spacing}>
        <ClinicalCard p={p} />
      </Row>

      <Row id="biospecimen" style={{ flexWrap: 'wrap' }} spacing={theme.spacing}>
        <BiospecimenCard p={p} />
      </Row>

      <Column style={{ ...styles.card, marginTop: '2rem' }}>
        <h1 style={{ ...styles.heading, padding: '1rem' }} id="frequent-mutations">
          <i className="fa fa-bar-chart-o" style={{ paddingRight: '10px' }} />
          Most Frequent Mutations
        </h1>

        <LocationSubscriber>{(ctx: {| pathname: string, query: TRawQuery |}) => {
          const { filters } = ctx.query || {};
          const currentFilters = parseFilterParam(filters, { op: 'and', content: [] });
          const componentFilters = replaceFilters(setFilter({ field: 'cases.case_id', value: p.case_id }), currentFilters);
          return (
            <FrequentMutations
              numCasesAggByProject={numCasesAggByProject}
              totalNumCases={totalNumCases}
              projectId={p.project.project_id}
              showSurvivalPlot={false}
              currentFilters={componentFilters}
            />
          );
        }}</LocationSubscriber>

      </Column>
    </Column>
  );
};

export default enhance(Case);
