/* @flow */

import '@ncigdc/theme/global.css';

import React from 'react';
import Relay from 'react-relay';
import { Route } from 'react-router-dom';
import { Provider } from 'react-redux';

import setupStore from '@ncigdc/dux';
import { fetchApiVersionInfo } from '@ncigdc/dux/versionInfo';

import RepositoryRoute from '@ncigdc/routes/RepositoryRoute';
import CohortRoute from '@ncigdc/routes/CohortRoute';
import ProjectsRoute from '@ncigdc/routes/ProjectsRoute';
import AnnotationsRoute from '@ncigdc/routes/AnnotationsRoute';
import ProjectRoute from '@ncigdc/routes/ProjectRoute';
import FileRoute from '@ncigdc/routes/FileRoute';
import CaseRoute from '@ncigdc/routes/CaseRoute';
import AnnotationRoute from '@ncigdc/routes/AnnotationRoute';
import CartRoute from '@ncigdc/routes/CartRoute';
import HomeRoute from '@ncigdc/routes/HomeRoute';
import GeneRoute from '@ncigdc/routes/GeneRoute';
import SSMRoute from '@ncigdc/routes/SSMRoute';

import Header from '@ncigdc/components/Header';
import Footer from '@ncigdc/components/Footer';
import SmartSearch from '@ncigdc/components/SmartSearch';
import NotificationContainer from '@ncigdc/components/NotificationContainer';
import RelayLoadingContainer from '@ncigdc/components/RelayLoadingContainer';

import { GlobalTooltip } from '@ncigdc/uikit/Tooltip';

const store = setupStore({
  persistConfig: {
    keyPrefix: 'ncigdcActive',
  },
});

store.dispatch(fetchApiVersionInfo());

const PortalComponent = () => (
  <Provider store={store}>
    <div style={{ position: 'relative', minHeight: '100vh' }}>
      <Header />
      <div style={{ padding: '91px 0 120px 0' }}>
        <Route exact path="/" component={HomeRoute} />
        <Route exact path="/cart" component={CartRoute} />
        <Route exact path="/repository" component={RepositoryRoute} />
        <Route exact path="/cohort" component={CohortRoute} />
        <Route exact path="/projects" component={ProjectsRoute} />
        <Route exact path="/annotations" component={AnnotationsRoute} />
        <Route exact path="/query" component={SmartSearch} />
        <Route path="/projects/:id" component={ProjectRoute} />
        <Route path="/files/:id" component={FileRoute} />
        <Route path="/cases/:id" component={CaseRoute} />
        <Route path="/annotations/:id" component={AnnotationRoute} />
        <Route path="/genes/:id" component={GeneRoute} />
        <Route path="/ssms/:id" component={SSMRoute} />
      </div>
      <Footer />

      <RelayLoadingContainer />
      <NotificationContainer />
      <GlobalTooltip />
    </div>
  </Provider>
);

const PortalQuery = {
  fragments: {
    viewer: () => Relay.QL`
      fragment on Root {
        user {
          username
        }
      }
    `,
  },
};

const Portal = Relay.createContainer(
  PortalComponent,
  PortalQuery
);

export default Portal;
