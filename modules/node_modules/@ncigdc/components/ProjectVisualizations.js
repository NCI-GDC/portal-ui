// @flow

import React from 'react';
import { compose, withState, lifecycle, withProps, withPropsOnChange } from 'recompose';
import LocationSubscriber from '@ncigdc/components/LocationSubscriber';

import { parseFilterParam } from '@ncigdc/utils/uri';
import { fetchApi } from '@ncigdc/utils/ajax';
import { getDefaultCurve } from '@ncigdc/utils/survivalplot';
import { makeFilter, setFilter, replaceFilters } from '@ncigdc/utils/filters';

import { Row, Column } from '@ncigdc/uikit/Flex';

import FrequentMutationsChart from '@ncigdc/containers/FrequentMutationsChart';
import FrequentMutationsTable from '@ncigdc/containers/FrequentMutationsTable';
import MostAffectedCasesChart from '@ncigdc/containers/MostAffectedCasesChart';
import MostAffectedCasesTable from '@ncigdc/containers/MostAffectedCasesTable';
import FrequentlyMutatedGenesChart from '@ncigdc/containers/FrequentlyMutatedGenesChart';
import FrequentlyMutatedGenesTable from '@ncigdc/containers/FrequentlyMutatedGenesTable';
import OncoGridWrapper from '@ncigdc/components/Oncogrid/OncogridWrapper';
import SurvivalPlotWrapper from '@ncigdc/components/SurvivalPlotWrapper';
import SpinnerCentered from '@ncigdc/components/SpinnerCentered';
import type { TRawQuery } from '@ncigdc/utils/uri/types';

const styles = {
  heading: {
    flexGrow: 1,
    fontSize: '2rem',
    marginBottom: 7,
    marginTop: 7,
  },
  card: {
    backgroundColor: 'white',
  },
};

const initialState = {
  loadingSurvival: true,
  loadingAggregation: true,
  numCasesAggByProject: {},
  mutatedGenesProject: {},
  defaultSurvivalData: {},
};

const enhance = compose(
  withProps({ survivalPlotSampleSize: 2000 }),
  withState('selectedMutatedGenesSurvivalData', 'setSelectedMutatedGenesSurvivalData', {}),
  withState('selectedFrequentMutationsSurvivalData', 'setSelectedFrequentMutationsSurvivalData', {}),
  withState('state', 'setState', initialState),
  withState('numCasesAggByProject', 'setNumCasesAggByProject', undefined),
  withPropsOnChange(
    ['projectId'],
    ({ setSelectedMutatedGenesSurvivalData, setSelectedFrequentMutationsSurvivalData }) => {
      setSelectedMutatedGenesSurvivalData({});
      setSelectedFrequentMutationsSurvivalData({});
    }
  ),
  withPropsOnChange(
    ['projectId', 'survivalPlotSampleSize'],
    async ({ projectId, setState, survivalPlotSampleSize }) => {
      if (!projectId) return;

      const defaultSurvivalData = await getDefaultCurve({
        currentFilters: { op: '=', content: { field: 'cases.project.project_id', value: projectId } },
        slug: projectId,
        size: survivalPlotSampleSize,
      });

      setState(s => ({
        ...s,
        loadingSurvival: false,
        defaultSurvivalData,
      }));
    }
  ),
  lifecycle({
    async componentDidMount(): Promise<*> {
      const mutatedCasesCountByProject = await fetchApi(
        'analysis/mutated_cases_count_by_project?size=0',
        { headers: { 'Content-Type': 'application/json' } }
      );

      const numCasesAggByProject = mutatedCasesCountByProject.aggregations.projects.buckets.reduce((acc, b) => ({
        ...acc,
        [b.key]: b.case_summary.case_with_ssm.doc_count,
      }), {});
      this.props.setNumCasesAggByProject(numCasesAggByProject);

      this.props.setState(s => ({
        ...s,
        loadingAggregation: false,
      }));
    },
  })
);

const ProjectVisualizations = enhance(({
  state: {
    defaultSurvivalData,
    numCasesAggByProject,
    loadingSurvival,
    loadingAggregation,
  },
  survivalPlotSampleSize,
  selectedMutatedGenesSurvivalData,
  setSelectedMutatedGenesSurvivalData,
  selectedFrequentMutationsSurvivalData,
  setSelectedFrequentMutationsSurvivalData,
  projectId,
  viewer,
}) => {
  const mutatedGenesSurvivalData = {
    legend: selectedMutatedGenesSurvivalData.legend || defaultSurvivalData.legend,
    rawData: selectedMutatedGenesSurvivalData.rawData || defaultSurvivalData.rawData,
  };

  const frequentMutationsSurvivalData = {
    legend: selectedFrequentMutationsSurvivalData.legend || defaultSurvivalData.legend,
    rawData: selectedFrequentMutationsSurvivalData.rawData || defaultSurvivalData.rawData,
  };

  const fmFilters = makeFilter([{ field: 'cases.project.project_id', value: projectId }], false);
  const macFilters = makeFilter([{ field: 'project.project_id', value: projectId }], false);

  return (
    <div>
      <Column style={styles.card}>
        <h1 style={{ ...styles.heading, padding: '1rem' }} id="mutated-genes">
          <i className="fa fa-bar-chart-o" style={{ paddingRight: '10px' }} />
          Most Frequently Mutated Genes
        </h1>
        <Column>
          <Row>
            <Column flex="none" style={{ width: '50%' }}>
              <FrequentlyMutatedGenesChart
                defaultFilters={fmFilters}
                projectId={projectId}
                cohort={viewer.cohort}
                numCasesAggByProject={numCasesAggByProject}
                context="project"
              />
            </Column>
            <Column flex="none" style={{ width: '50%' }}>
              <SurvivalPlotWrapper
                {...mutatedGenesSurvivalData}
                onReset={() => setSelectedMutatedGenesSurvivalData({})}
                height={240}
                survivalPlotloading={loadingSurvival}
              />
            </Column>
          </Row>
          <FrequentlyMutatedGenesTable
            survivalData={mutatedGenesSurvivalData}
            setSelectedSurvivalData={setSelectedMutatedGenesSurvivalData}
            selectedSurvivalData={selectedMutatedGenesSurvivalData}
            defaultFilters={fmFilters}
            projectIds={[projectId]}
            cohort={viewer.cohort}
            numCasesAggByProject={numCasesAggByProject}
            projectBreakdown={viewer.cohort}
            survivalPlotSampleSize={survivalPlotSampleSize}
          />
        </Column>
      </Column>

      <Column style={{ ...styles.card, marginTop: '2rem', position: 'static' }}>
        <h1 style={{ ...styles.heading, padding: '1rem' }} id="oncogrid">
          <i className="fa fa-th" style={{ paddingRight: '10px' }} />
          OncoGrid
        </h1>
        <LocationSubscriber>{(ctx: {| pathname: string, query: TRawQuery |}) => {
          const { filters } = ctx.query || {};
          const currentFilters = parseFilterParam(filters, { op: 'and', content: [] });
          const componentFilters = replaceFilters(
            setFilter({ field: 'cases.project.project_id', value: projectId }),
            currentFilters
          );
          return (
            <OncoGridWrapper
              projectId={projectId}
              currentFilters={componentFilters}
            />
          );
        }}</LocationSubscriber>
      </Column>

      <Column style={{ ...styles.card, marginTop: '2rem' }}>
        <h1 style={{ ...styles.heading, padding: '1rem' }} id="frequent-mutations">
          <i className="fa fa-bar-chart-o" style={{ paddingRight: '10px' }} />
          Most Frequent Mutations
        </h1>
        <Column>
          <Row>
            <Column flex="1">
              {
                loadingAggregation ? <SpinnerCentered /> : (
                  <FrequentMutationsChart
                    projectId={projectId}
                    defaultFilters={fmFilters}
                    cohort={viewer.cohort}
                    showSurvivalPlot
                  />
                )
              }
            </Column>
            <Column flex="1">
              <SurvivalPlotWrapper
                {...frequentMutationsSurvivalData}
                onReset={() => setSelectedFrequentMutationsSurvivalData({})}
                height={240}
                survivalPlotloading={loadingSurvival}
              />
            </Column>
          </Row>
          {
            loadingAggregation ? <SpinnerCentered /> : (
              <FrequentMutationsTable
                projectId={projectId}
                defaultFilters={fmFilters}
                cohort={viewer.cohort}
                selectedSurvivalData={selectedFrequentMutationsSurvivalData}
                setSelectedSurvivalData={setSelectedFrequentMutationsSurvivalData}
                showSurvivalPlot
                survivalPlotSampleSize={survivalPlotSampleSize}
                projectBreakdown={viewer.cohort}
              />
            )
          }
        </Column>
      </Column>
      <Column style={{ ...styles.card, marginTop: '2rem' }}>
        <h1 style={{ ...styles.heading, padding: '1rem' }} id="most-affected-cases">
          <i className="fa fa-bar-chart-o" style={{ paddingRight: '10px' }} />
          Most Affected Cases
        </h1>
        <MostAffectedCasesChart
          cohort={viewer.cohort}
          defaultFilters={macFilters}
          style={{ width: '50%', flexGrow: 0 }}
        />
        <MostAffectedCasesTable
          cohort={viewer.cohort}
          defaultFilters={macFilters}
        />
      </Column>
    </div>
  );
});

export default ProjectVisualizations;
