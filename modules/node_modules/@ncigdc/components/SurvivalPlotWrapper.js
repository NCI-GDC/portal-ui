// @flow

import React from 'react';
import { compose, lifecycle, withState } from 'recompose';
import _ from 'lodash';
import { scaleOrdinal, schemeCategory10 } from 'd3';
import { renderPlot } from '@oncojs/survivalplot';
import Loader from '@ncigdc/uikit/Loaders/Loader';
import toMap from '@ncigdc/utils/toMap';
import { Row, Column } from '@ncigdc/uikit/Flex';
import Button from '@ncigdc/uikit/Button';
import { Tooltip, withTooltip } from '@ncigdc/uikit/Tooltip';
import Hidden from '@ncigdc/components/Hidden';
import withRouter from '@ncigdc/utils/withRouter';

import DownloadVisualizationButton from '@ncigdc/components/DownloadVisualizationButton';

import { graphTitle, visualizingButton } from '@ncigdc/theme/mixins';

import './survivalPlot.css';

type TProps = {
  height: number,
  legend: Array<{
    key: string,
    value: any,
  }>,
  rawData: {
    results: Array<{
      donors: Array<Object>,
      meta: {
        id: string | number,
        label: string,
      },
    }>,
    overallStats: {
      pValue: number,
    },
  },
  setXDomain: Function,
  setSurvivalContainer: Function,
  survivalPlotloading: boolean,
  xDomain: Array<number>,
  survivalContainer: Element,
  setTooltip: Function,
  push: Function,
};

const SVG_MARGINS = {
  top: 15,
  right: 20,
  bottom: 40,
  left: 50,
};

const colors = scaleOrdinal(schemeCategory10);
const palette = [colors(0), colors(1)];

const styles = {
  pValue: {
    fontSize: '1.1rem',
    height: '1.5rem',
    marginTop: '0.5rem',
    textAlign: 'center',
  },
};

const SurvivalPlotWrapper = ({
  height = 0,
  legend,
  rawData,
  setXDomain,
  setSurvivalContainer,
  survivalPlotloading = false,
}: TProps) => {
  const { results = [], overallStats = {} } = rawData || {};
  const pValue = overallStats.pValue;

  return (
    <Loader
      loading={survivalPlotloading}
      height="400px"
      className="survival-plot"
    >
      {
        !survivalPlotloading && (
          <Column>
            <Row style={{ justifyContent: 'flex-end', marginRight: '12px' }} spacing="1rem">
              <DownloadVisualizationButton
                svg={'.survival-plot-container svg'}
                data={results}
                stylePrefix=".survival-plot"
                slug="survival-plot"
                noText
                tooltipHTML="Download SurvivalPlot data or image"
                tsvData={
                  results.reduce((data, set) => {
                    const mapData = set.donors.map((d) => toMap(d));
                    return [...data, ...(results.length > 1 ? mapData.map((m) => m.set('label', set.meta.label)) : mapData)];
                  }, [])
                }
              />
              <Tooltip Component="Reset SurvivalPlot Zoom">
                <Button
                  style={visualizingButton}
                  onClick={() => setXDomain()}
                ><i className="fa fa-undo" /><Hidden>Reset</Hidden></Button>
              </Tooltip>
            </Row>
            <div style={graphTitle()}>Overall Survival Plot</div>
            <Row style={{ justifyContent: 'center', flexWrap: 'wrap', marginTop: '0.5rem' }}>
              {legend &&
                legend.map((l, i) => (
                  <div
                    key={l.key}
                    style={{
                      color: palette[i],
                      margin: '0 1rem',
                      fontSize: '1.35rem',
                    }}
                  >{l.value}</div>
                ))
              }
            </Row>
            {
              <div style={styles.pValue}>
                {pValue && `Log-Rank Test P-Value = ${pValue.toExponential(2)}`}
              </div>
            }
            <div
              style={{
                textAlign: 'right',
                marginBottom: -SVG_MARGINS.top,
                marginRight: SVG_MARGINS.right,
                fontSize: '1.1rem',
              }}
            >
              drag to zoom
            </div>
          </Column>
        )
      }
      <div
        className="survival-plot-container"
        ref={setSurvivalContainer}
        style={{ overflow: 'hidden', height: survivalPlotloading ? '0px' : height, position: 'relative' }}
      />
    </Loader>
  );
};

function renderSurvivalPlot(props: TProps): void {
  const { height = 0, rawData = {}, xDomain, survivalContainer, setXDomain, setTooltip, push } = props;
  const { results = [] } = rawData;

  if (survivalContainer) {
    renderPlot({
      container: survivalContainer,
      dataSets: results,
      palette,
      xDomain,
      xAxisLabel: 'Duration (days)',
      yAxisLabel: 'Survival Rate',
      height,
      getSetSymbol: (curve, curves) => (
        curves.length === 1 ?
          '' :
          `<tspan font-style="italic">S</tspan><tspan font-size="0.7em" baseline-shift="-15%">${
          curves.indexOf(curve) + 1
        }</tspan>`
      ),
      onMouseEnterDonor: (e, donor) => {
        setTooltip(
          <span>
            Case ID: {donor.id}<br />
            Survival Rate: {Math.round(donor.survivalEstimate * 100)}%<br />
            {donor.censored ? `Interval of last follow-up: ${donor.time} days` : `Time of Death: ${donor.time} days`}
          </span>
        );
      },
      onMouseLeaveDonor: () => setTooltip(),
      onClickDonor: (e, donor) => push({ pathname: `/cases/${donor.id}` }),
      onDomainChange: setXDomain,
      margins: SVG_MARGINS,
    });
  }
}

const enhance = compose(
  withTooltip,
  withRouter,
  withState('xDomain', 'setXDomain', undefined),
  withState('survivalContainer', 'setSurvivalContainer', null),

  lifecycle({
    shouldComponentUpdate(nextProps: TProps): void {
      return !_.isEqual(this.props, nextProps); // eslint-disable-line fp/no-this
    },

    componentDidUpdate(): void {
      renderSurvivalPlot(this.props); // eslint-disable-line fp/no-this
    },

    componentDidMount(): void {
      renderSurvivalPlot(this.props); // eslint-disable-line fp/no-this
    },
  })
);

export default enhance(SurvivalPlotWrapper);
