// @flow
/* global $ */

import React from 'react';
import { connect } from 'react-redux';
import { compose, lifecycle, withState, withProps } from 'recompose';
import Lolliplot from '@oncojs/lolliplot';
import * as d3 from 'd3';
import { isEqual } from 'lodash';

import withRouter from '@ncigdc/utils/withRouter';
import { buildProteinLolliplotData } from '@ncigdc/utils/data';

import { Row, Column } from '@ncigdc/uikit/Flex';
import { setTooltip } from '@ncigdc/uikit/Tooltip';
import { makeFilter } from '@ncigdc/utils/filters';

import MinusIcon from '@ncigdc/theme/icons/Minus';
import PlusIcon from '@ncigdc/theme/icons/Plus';
import ChartIcon from '@ncigdc/theme/icons/BarChart';

import CancerDistributionChart from '@ncigdc/containers/CancerDistributionChart';
import CancerDistributionTable from '@ncigdc/containers/CancerDistributionTable';
import FrequentMutationsChart from '@ncigdc/containers/FrequentMutationsChart';
import FrequentMutationsTable from '@ncigdc/containers/FrequentMutationsTable';
import GeneSummary from '@ncigdc/containers/GeneSummary';
import GeneExternalReferences from '@ncigdc/containers/GeneExternalReferences';

import ProteinLolliplotComponent from './ProteinLolliplot';

const styles = {
  heading: {
    flexGrow: 1,
    fontSize: '2.2rem',
    marginBottom: 7,
    marginTop: 7,
    display: 'flex',
    alignItems: 'center',
  },
  card: {
    backgroundColor: 'white',
  },
};

const strandIconMap = {
  '-1': <MinusIcon />,
  1: <PlusIcon />,
};

const initialState = {
  ProteinLolliplot: {},
  allCasesAgg: [],
  ssmsLoading: true,
};

const Gene = compose(
  withState('state', 'setState', initialState),
  withState('activeTranscript', 'setActiveTranscript'),
  connect(),
  withRouter,
  withProps({
    renderProteinLolliplot(data, transcript, { setState, dispatch, push, state: { ProteinLolliplot } }): void {
      const proteinLolliplotData = buildProteinLolliplotData({ transcript, data });
      if (ProteinLolliplot.remove) ProteinLolliplot.remove();
      setState(s => ({
        ...s,
        ProteinLolliplot: Lolliplot({
          d3,
          data: proteinLolliplotData,
          selector: '#protein-viewer-root',
          height: 450,
          domainWidth: transcript.length_amino_acid,
          onMutationClick: d => { push(`/ssms/${d.id}`); },
          onMutationMouseover: d => {
            dispatch(setTooltip(
              <span>
                <div>AA Change: {d.aa_change}</div>
                <div>Mutation ID: {d.id}</div>
                <div># of Cases: {d.donors}</div>
                <div>Functional Impact: {d.impact}</div>
              </span>
            ));
          },
          onMutationMouseout: () => dispatch(setTooltip(null)),
          onProteinMouseover: d => {
            dispatch(setTooltip(
              <span>
                <div>{d.id}</div>
                <div>{d.description}</div>
                <div><b>Click to zoom</b></div>
              </span>
            ));
          },
          onProteinMouseout: () => dispatch(setTooltip(null)),
        }),
      }));
    },
  }),
  lifecycle({
    componentWillReceiveProps(nextProps: {}): void {
      if (!nextProps.ssms.length) return;

      const canonicalTranscript = nextProps.node.transcripts.hits.edges.find(x => x.node.is_canonical).node;
      const activeTranscript = nextProps.activeTranscript;

      if (!this.props.ssms.length || !isEqual(this.props.activeTranscript || canonicalTranscript, activeTranscript)) {
        const transcript = activeTranscript || canonicalTranscript;
        const data = nextProps.ssms.map(x => x.node);

        nextProps.renderProteinLolliplot(data, transcript, nextProps);
        nextProps.setActiveTranscript(transcript);
        nextProps.setState(s => ({ ...s, ssmsLoading: false }));
      }
    },
  })
)(({
  state: { ProteinLolliplot, ssmsLoading },
  activeTranscript,
  setActiveTranscript,
  node: gene,
  viewer,
}) => {
  const fmFilters = makeFilter([
    {
      field: 'consequence.transcript.gene.gene_id',
      value: [gene.gene_id],
    },
    {
      field: 'consequence.transcript.transcript_id',
      value: [(gene.transcripts.hits.edges.find(x => x.node.is_canonical) || {}).node.transcript_id],
    },
  ], false);

  return (
    <Column spacing="2rem">
      <Row spacing="2rem">
        <Row flex="1"><GeneSummary node={gene} /></Row>
        <Row flex="1"><GeneExternalReferences node={gene} /></Row>
      </Row>
      <Column style={styles.card} id="cancer-distribution">
        <Row>
          <h1 style={{ ...styles.heading, padding: '1rem' }}>
            <ChartIcon style={{ marginRight: '1rem' }} />
            Cancer Distribution
          </h1>
        </Row>
        <Column>
          <CancerDistributionChart node={gene} aggregations={viewer.cohort.cases.aggregations} />
          <CancerDistributionTable node={gene} aggregations={viewer.cohort.cases.aggregations} />
        </Column>
      </Column>

      <Column style={{ ...styles.card, marginTop: '2rem' }}>
        <ProteinLolliplotComponent
          gene={gene}
          reset={ProteinLolliplot.reset}
          transcripts={gene.transcripts.hits.edges.map(x => x.node)}
          activeTranscript={activeTranscript}
          loading={ssmsLoading}
          selectTranscript={setActiveTranscript}
        />
      </Column>

      <Column style={{ ...styles.card, marginTop: '2rem' }}>
        <h1 style={{ ...styles.heading, padding: '1rem' }} id="frequent-mutations">
          <ChartIcon style={{ marginRight: '1rem' }} />
          Most Frequent Mutations
        </h1>

        <Column>
          <FrequentMutationsChart
            defaultFilters={fmFilters}
            cohort={viewer.frequentMutationsChartFragment}
          />
          <FrequentMutationsTable
            defaultFilters={fmFilters}
            cohort={viewer.frequentMutationsTableFragment}
          />
        </Column>
      </Column>
    </Column>
  );
});

export default Gene;
